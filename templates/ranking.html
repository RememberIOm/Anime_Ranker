{% extends "base.html" %}

{% block content %}
<div class="space-y-8">

    <!-- 헤더 -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Ranking Board</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">항목별 점수를 클릭하여 랭킹을 정렬하세요.</p>
        </div>

        <!-- 카테고리 필터 (가로 스크롤 가능) -->
        <div class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
            {% set filters = [
            ('total', '종합', 'yellow'),
            ('story', '스토리', 'blue'),
            ('visual', '작화', 'purple'),
            ('ost', 'OST', 'pink'),
            ('voice', '성우', 'green'),
            ('char', '캐릭터', 'indigo'),
            ('fun', '재미', 'red')
            ] %}

            {% for key, label, color in filters %}
            <a href="/ranking?sort_by={{ key }}" class="px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all duration-200 border 
               {% if sort_by == key %}
                   bg-{{ color }}-500 text-white border-{{ color }}-600 shadow-md transform scale-105
               {% else %}
                   bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700
               {% endif %}">
                {{ label }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- 차트 영역 -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">
            Distribution: <span class="text-brand-600 dark:text-brand-400">{{ chart_data.category }}</span>
        </h2>
        <div class="h-64 w-full relative">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>

    <!-- 랭킹 테이블 -->
    <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse whitespace-nowrap">
                <thead>
                    <tr
                        class="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700 text-xs uppercase text-gray-500 dark:text-gray-400 font-semibold">
                        <th class="p-4 text-center w-16">#</th>
                        <th class="p-4">Title</th>
                        <th class="p-4 text-center text-yellow-600 dark:text-yellow-400 bg-yellow-50/50 dark:bg-yellow-900/10 cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/20 transition"
                            onclick="location.href='/ranking?sort_by=total'">Total</th>
                        <th class="p-4 text-center cursor-pointer hover:text-blue-500"
                            onclick="location.href='/ranking?sort_by=story'">Story</th>
                        <th class="p-4 text-center cursor-pointer hover:text-purple-500"
                            onclick="location.href='/ranking?sort_by=visual'">Visual</th>
                        <th class="p-4 text-center cursor-pointer hover:text-pink-500"
                            onclick="location.href='/ranking?sort_by=ost'">OST</th>
                        <th class="p-4 text-center cursor-pointer hover:text-green-500"
                            onclick="location.href='/ranking?sort_by=voice'">Voice</th>
                        <th class="p-4 text-center cursor-pointer hover:text-indigo-500"
                            onclick="location.href='/ranking?sort_by=char'">Char</th>
                        <th class="p-4 text-center cursor-pointer hover:text-red-500"
                            onclick="location.href='/ranking?sort_by=fun'">Fun</th>
                        <th class="p-4 text-center text-gray-400">Matches</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for ani in animes %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors group">
                        <td class="p-4 text-center font-mono text-gray-400 text-sm">{{ loop.index }}</td>
                        <td
                            class="p-4 font-bold text-gray-800 dark:text-gray-100 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors">
                            {{ ani.name }}
                        </td>
                        <td
                            class="p-4 text-center font-mono font-bold text-lg text-yellow-600 dark:text-yellow-400 bg-yellow-50/30 dark:bg-yellow-900/10">
                            {{ ani.total }}
                        </td>
                        <!-- 각 점수 셀: 정렬된 컬럼 강조 -->
                        {% for key, val in [('story', ani.story), ('visual', ani.visual), ('ost', ani.ost), ('voice',
                        ani.voice), ('char', ani.char), ('fun', ani.fun)] %}
                        <td
                            class="p-4 text-center font-mono text-sm
                            {% if sort_by == key %} font-bold text-gray-900 dark:text-white {% else %} text-gray-500 dark:text-gray-400 {% endif %}">
                            {{ val }}
                        </td>
                        {% endfor %}

                        <td class="p-4 text-center">
                            <span
                                class="text-xs font-mono px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">
                                {{ ani.matches }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ chart_data.labels | safe }};
    const counts = {{ chart_data.counts | safe }};
    const categoryName = "{{ chart_data.category }}";

    // 카테고리별 테마 색상 매핑
    const colorMap = {
        'STORY': '59, 130, 246', // blue-500
        'VISUAL': '168, 85, 247', // purple-500
        'OST': '236, 72, 153', // pink-500
        'VOICE': '34, 197, 94', // green-500
        'CHAR': '99, 102, 241', // indigo-500
        'FUN': '239, 68, 68', // red-500
        '종합 점수': '234, 179, 8' // yellow-500
    };

    // 기본값은 Brand Color (Violet)
    let colorTheme = colorMap[categoryName] || '139, 92, 246';

    const ctx = document.getElementById('distributionChart').getContext('2d');

    // 테마 감지 및 차트 옵션 설정 함수
    function getChartOptions() {
        const isDark = document.documentElement.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
        const textColor = isDark ? '#94a3b8' : '#64748b';

        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)',
                    titleColor: isDark ? '#fff' : '#1e293b',
                    bodyColor: isDark ? '#ccc' : '#475569',
                    borderColor: isDark ? '#333' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: false
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: textColor }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: gridColor, borderDash: [4, 4] },
                    ticks: { color: textColor, precision: 0 }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        };
    }

    let chartInstance = null;

    function initChart() {
        if (chartInstance) chartInstance.destroy();

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, `rgba(${colorTheme}, 0.5)`);
        gradient.addColorStop(1, `rgba(${colorTheme}, 0.0)`);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Count',
                    data: counts,
                    borderColor: `rgba(${colorTheme}, 1)`,
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: `rgba(${colorTheme}, 1)`,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: `rgba(${colorTheme}, 1)`,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: getChartOptions()
        });
    }

    initChart();

    // 테마 변경 시 차트 재렌더링
    window.addEventListener('theme-changed', initChart);
</script>
{% endblock %}