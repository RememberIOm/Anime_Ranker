{% extends "base.html" %}

{% block content %}

{# --- Macro Definition --- #}
{% macro battle_card(anime, rank, side, color) %}
<div id="card-{{ '1' if side == 'left' else '2' }}" onclick="submitVote('{{ '1' if side == 'left' else '2' }}')"
    class="group relative bg-white dark:bg-gray-800 rounded-[2rem] p-6 md:p-8 shadow-xl hover:shadow-2xl hover:shadow-{{ color }}-500/20 border-2 border-transparent hover:border-{{ color }}-500 cursor-pointer transition-all duration-300 transform hover:-translate-y-2 flex flex-col justify-between items-center min-h-[320px] md:min-h-[480px]">

    <!-- Rank Badge -->
    <div class="absolute top-4 right-4 flex flex-col items-end gap-1 pointer-events-none">
        <div
            class="bg-gray-900/5 dark:bg-white/10 backdrop-blur-md px-3 py-1 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 border border-white/20">
            #<span class="font-mono text-sm">{{ rank.rank }}</span>
        </div>
        {% if rank.top_percent <= 30 %} <div
            class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider shadow-sm">
            Top {{ rank.top_percent }}%
    </div>
    {% endif %}
</div>

<!-- Letter Circle -->
<div
    class="absolute top-4 left-4 w-12 h-12 md:w-16 md:h-16 rounded-2xl bg-gray-50 dark:bg-gray-700/50 flex items-center justify-center font-black text-xl md:text-2xl text-gray-300 dark:text-gray-600 group-hover:bg-{{ color }}-500 group-hover:text-white transition-all duration-300 shadow-inner group-hover:shadow-lg group-hover:scale-110 group-hover:rotate-6 mb-4">
    {{ 'A' if side == 'left' else 'B' }}
</div>

<!-- Name -->
<div class="flex-grow flex items-center justify-center w-full my-4">
    <h3
        class="text-2xl sm:text-3xl md:text-4xl font-black text-center text-gray-800 dark:text-gray-100 group-hover:text-{{ color }}-600 dark:group-hover:text-{{ color }}-400 break-words leading-tight transition-colors w-full px-2">
        {{ anime.name }}
    </h3>
</div>

<!-- Stats -->
<div class="w-full flex justify-center mt-4">
    <div
        class="bg-gray-50 dark:bg-gray-700/50 px-6 py-2 rounded-full border border-gray-100 dark:border-gray-600 group-hover:border-{{ color }}-200 dark:group-hover:border-{{ color }}-800 transition-colors">
        <span class="text-xs text-gray-400 uppercase mr-2 font-bold">Rating</span>
        <span
            class="text-lg font-mono font-bold text-gray-700 dark:text-gray-200 group-hover:text-{{ color }}-600 dark:group-hover:text-{{ color }}-300">
            {{ anime['rating_' + category_key]|round|int }}
        </span>
    </div>
</div>

<!-- Winner Overlay -->
<div id="result-overlay-{{ '1' if side == 'left' else '2' }}"
    class="absolute inset-0 bg-{{ color }}-500/10 dark:bg-{{ color }}-400/10 rounded-[2rem] border-4 border-{{ color }}-500 hidden transition-all z-20 backdrop-blur-[2px]">
    <div class="absolute inset-0 flex items-center justify-center">
        <span
            class="bg-{{ color }}-600 text-white text-2xl md:text-4xl font-black px-8 py-3 rounded-2xl shadow-2xl transform {{ '-rotate-12' if side == 'left' else 'rotate-12' }} scale-110 border-4 border-white/20">
            WINNER
        </span>
    </div>
</div>
</div>
{% endmacro %}
{# --- End Macro --- #}


<div class="relative flex flex-col items-center justify-center min-h-[80vh] py-8">

    <!-- ÏßëÏ§ë Î™®Îìú ÏïåÎ¶º -->
    {% if focus_mode %}
    <div class="fixed top-20 left-1/2 transform -translate-x-1/2 z-40 animate-bounce-in">
        <div
            class="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-xl flex items-center gap-2 backdrop-blur-sm ring-4 ring-blue-500/20">
            <span class="animate-pulse">üéØ</span>
            <span>'{{ anime1.name }}' ÏßëÏ§ë ÌèâÍ∞Ä Ï§ë</span>
            <a href="/manage" class="ml-2 text-blue-200 hover:text-white underline text-xs">Ï¢ÖÎ£å</a>
        </div>
    </div>
    {% endif %}

    <!-- Ìó§Îçî ÏÑπÏÖò -->
    <div class="text-center mb-8 md:mb-12 z-10 px-4 space-y-2">
        <div
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-xs font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400">
            <span>Battle Arena</span>
            <span class="w-1 h-1 rounded-full bg-gray-400"></span>
            <span>Category: {{ category_name }}</span>
        </div>
        <h2 class="text-3xl md:text-5xl font-black text-gray-900 dark:text-white break-words drop-shadow-sm">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-pink-500">{{ category_name
                }}</span>,
            Ïñ¥Îäê Ï™ΩÏù¥ Îçî ÌõåÎ•≠ÌïúÍ∞ÄÏöî?
        </h2>
    </div>

    <!-- ÎåÄÍ≤∞ Ïπ¥Îìú ÏòÅÏó≠ -->
    <div class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6 md:gap-8 items-stretch px-4">

        <!-- Anime 1 -->
        {{ battle_card(anime1, rank1, 'left', 'brand') }}

        <!-- VS Section (Center) -->
        <div class="flex flex-col items-center justify-center gap-6 z-20 py-4 md:py-0 min-w-[140px]">
            <div class="relative">
                <div
                    class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-white dark:bg-gray-800 flex items-center justify-center font-black text-xl md:text-2xl italic text-gray-300 dark:text-gray-600 shadow-xl ring-8 ring-gray-50 dark:ring-gray-900 z-10 relative">
                    VS
                </div>
                <div
                    class="absolute inset-0 rounded-full bg-gradient-to-br from-brand-500 to-pink-500 blur-lg opacity-30 animate-pulse">
                </div>
            </div>

            <!-- ÌôïÎ•† Í∑∏ÎûòÌîÑ -->
            <div
                class="w-full flex flex-col gap-2 items-center px-2 bg-white/50 dark:bg-gray-800/50 p-4 rounded-2xl backdrop-blur-sm border border-gray-100 dark:border-gray-700 shadow-sm">
                <div class="flex justify-between w-full text-xs font-bold text-gray-500 dark:text-gray-400">
                    <span class="text-brand-600 dark:text-brand-400">{{ probs.win_a }}%</span>
                    <span>Draw</span>
                    <span class="text-pink-600 dark:text-pink-400">{{ probs.win_b }}%</span>
                </div>
                <div class="flex w-full h-2 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-700/50">
                    <div style="width: {{ probs.win_a }}%"
                        class="bg-brand-500 h-full shadow-[0_0_10px_rgba(139,92,246,0.5)]"></div>
                    <div style="width: {{ probs.draw }}%" class="bg-gray-300 dark:bg-gray-600 h-full"></div>
                    <div style="width: {{ probs.win_b }}%"
                        class="bg-pink-500 h-full shadow-[0_0_10px_rgba(236,72,153,0.5)]"></div>
                </div>
            </div>

            <button onclick="submitVote('draw')"
                class="group relative px-8 py-3 rounded-full bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 font-bold text-sm hover:border-gray-400 dark:hover:border-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition-all shadow-sm hover:shadow-md active:scale-95">
                Î¨¥ÏäπÎ∂Ä
            </button>
        </div>

        <!-- Anime 2 -->
        {{ battle_card(anime2, rank2, 'right', 'pink') }}

    </div>
</div>

<!-- Í≤∞Í≥º Î™®Îã¨ -->
<div id="result-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
    <div
        class="bg-white dark:bg-gray-900 p-8 rounded-[2rem] shadow-2xl max-w-lg w-full mx-4 border border-gray-100 dark:border-gray-800 transform scale-95 transition-transform duration-300 relative overflow-hidden">

        <!-- Background Decor -->
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 via-purple-500 to-pink-500"></div>

        <h3 class="text-2xl font-black text-center mb-8">
            <span
                class="bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300">
                Battle Result
            </span>
        </h3>

        <div class="flex items-stretch justify-between gap-4 mb-8">
            <!-- P1 Result -->
            <div class="flex-1 flex flex-col items-center bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-4">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Left Side</div>
                <div
                    class="text-sm font-bold text-gray-800 dark:text-gray-200 text-center line-clamp-1 mb-3 px-2 w-full">
                    {{ anime1.name }}
                </div>

                <!-- Score -->
                <div class="flex items-baseline gap-1 mb-2">
                    <span id="score-1" class="text-3xl font-mono font-black text-gray-900 dark:text-white">1200</span>
                    <span id="diff-1"
                        class="text-xs font-bold opacity-0 transform translate-y-2 transition-all duration-500"></span>
                </div>

                <!-- Rank -->
                <div
                    class="flex items-center gap-1.5 text-xs bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm mt-auto w-full justify-center">
                    <span class="text-gray-400">Rank</span>
                    <span id="rank-old-1" class="font-mono text-gray-500 line-through decoration-red-500/50"></span>
                    <span class="text-gray-300">‚Üí</span>
                    <span id="rank-new-1" class="font-mono font-bold text-gray-800 dark:text-gray-200"></span>
                    <span id="rank-change-1"></span>
                </div>
            </div>

            <!-- P2 Result -->
            <div class="flex-1 flex flex-col items-center bg-gray-50 dark:bg-gray-800/50 rounded-2xl p-4">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Right Side</div>
                <div
                    class="text-sm font-bold text-gray-800 dark:text-gray-200 text-center line-clamp-1 mb-3 px-2 w-full">
                    {{ anime2.name }}
                </div>

                <!-- Score -->
                <div class="flex items-baseline gap-1 mb-2">
                    <span id="score-2" class="text-3xl font-mono font-black text-gray-900 dark:text-white">1200</span>
                    <span id="diff-2"
                        class="text-xs font-bold opacity-0 transform translate-y-2 transition-all duration-500"></span>
                </div>

                <!-- Rank -->
                <div
                    class="flex items-center gap-1.5 text-xs bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm mt-auto w-full justify-center">
                    <span class="text-gray-400">Rank</span>
                    <span id="rank-old-2" class="font-mono text-gray-500 line-through decoration-red-500/50"></span>
                    <span class="text-gray-300">‚Üí</span>
                    <span id="rank-new-2" class="font-mono font-bold text-gray-800 dark:text-gray-200"></span>
                    <span id="rank-change-2"></span>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="relative w-full h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden mb-4">
            <div id="progress-bar"
                class="absolute left-0 top-0 h-full bg-gradient-to-r from-brand-500 to-pink-500 w-0 transition-all duration-[1500ms] ease-out">
            </div>
        </div>
        <p class="text-center text-[10px] text-gray-400 uppercase tracking-widest animate-pulse">Redirecting...</p>
    </div>
</div>

<style>
    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: translate(-50%, -20px);
        }

        50% {
            transform: translate(-50%, 5px);
        }

        100% {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }

    .animate-bounce-in {
        animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    const anime1Id = "{{ anime1.id }}";
    const anime2Id = "{{ anime2.id }}";
    const categoryKey = "{{ category_key }}";
    const redirectTo = "{% if focus_mode %}/battle/focus/{{ focus_id }}{% endif %}";

    async function submitVote(winner) {
        if (winner === '1') document.getElementById('result-overlay-1').classList.remove('hidden');
        if (winner === '2') document.getElementById('result-overlay-2').classList.remove('hidden');
        document.body.style.pointerEvents = 'none';

        const formData = new FormData();
        formData.append('anime1_id', anime1Id);
        formData.append('anime2_id', anime2Id);
        formData.append('category', categoryKey);
        formData.append('winner', winner);
        if (redirectTo) formData.append('redirect_to', redirectTo);

        try {
            const response = await fetch('/battle/vote', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            showResultAnimation(data);
        } catch (error) {
            console.error('Error:', error);
            location.reload();
        }
    }

    function showResultAnimation(data) {
        const modal = document.getElementById('result-modal');
        const content = modal.querySelector('div');

        const score1El = document.getElementById('score-1');
        const diff1El = document.getElementById('diff-1');
        const rankOld1 = document.getElementById('rank-old-1');
        const rankNew1 = document.getElementById('rank-new-1');
        const rankChange1 = document.getElementById('rank-change-1');

        const score2El = document.getElementById('score-2');
        const diff2El = document.getElementById('diff-2');
        const rankOld2 = document.getElementById('rank-old-2');
        const rankNew2 = document.getElementById('rank-new-2');
        const rankChange2 = document.getElementById('rank-change-2');

        const progressBar = document.getElementById('progress-bar');

        score1El.innerText = data.old_r1;
        score2El.innerText = data.old_r2;

        rankOld1.innerText = "#" + data.old_rank_1;
        rankNew1.innerText = "#" + data.new_rank_1;
        rankOld2.innerText = "#" + data.old_rank_2;
        rankNew2.innerText = "#" + data.new_rank_2;

        setRankChangeStyle(rankChange1, data.old_rank_1, data.new_rank_1);
        setRankChangeStyle(rankChange2, data.old_rank_2, data.new_rank_2);

        setDiffStyle(diff1El, data.diff_r1);
        setDiffStyle(diff2El, data.diff_r2);

        modal.classList.remove('hidden');
        void modal.offsetWidth;
        modal.classList.remove('opacity-0');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');

        setTimeout(() => {
            animateValue(score1El, data.old_r1, data.new_r1, 600);
            animateValue(score2El, data.old_r2, data.new_r2, 600);
            diff1El.classList.remove('opacity-0', 'translate-y-2');
            diff2El.classList.remove('opacity-0', 'translate-y-2');
            progressBar.style.width = "100%";
        }, 100);

        setTimeout(() => {
            window.location.href = data.next_url;
        }, 1800);
    }

    function setDiffStyle(element, diff) {
        if (diff > 0) {
            element.innerText = "+" + diff;
            element.className = "text-xs font-bold px-1.5 py-0.5 rounded bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400 opacity-0 transform translate-y-2 transition-all duration-500";
        } else if (diff < 0) {
            element.innerText = diff;
            element.className = "text-xs font-bold px-1.5 py-0.5 rounded bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400 opacity-0 transform translate-y-2 transition-all duration-500";
        } else {
            element.innerText = "-";
            element.className = "text-xs font-bold px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 opacity-0 transform translate-y-2 transition-all duration-500";
        }
    }

    function setRankChangeStyle(element, oldRank, newRank) {
        if (newRank < oldRank) {
            element.innerHTML = "‚ñ≤";
            element.className = "text-green-500 font-bold ml-1 animate-bounce";
        } else if (newRank > oldRank) {
            element.innerHTML = "‚ñº";
            element.className = "text-red-500 font-bold ml-1";
        } else {
            element.innerHTML = "-";
            element.className = "text-gray-300 ml-1";
        }
    }

    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end;
            }
        };
        window.requestAnimationFrame(step);
    }
</script>
{% endblock %}