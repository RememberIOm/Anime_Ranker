{% extends "base.html" %}

{% block content %}
<div class="relative flex flex-col items-center justify-center min-h-[80vh] py-8">

    <!-- ì§‘ì¤‘ ëª¨ë“œ ì•Œë¦¼ -->
    {% if focus_mode %}
    <div class="fixed top-20 left-1/2 transform -translate-x-1/2 z-40">
        <div
            class="bg-blue-600/90 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2 backdrop-blur-sm">
            <span class="animate-pulse">ğŸ¯</span>
            <span>'{{ anime1.name }}' ì§‘ì¤‘ í‰ê°€ ì¤‘</span>
            <a href="/manage" class="ml-2 text-blue-200 hover:text-white underline text-xs">ì¢…ë£Œ</a>
        </div>
    </div>
    {% endif %}

    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="text-center mb-8 md:mb-12 z-10 px-4">
        <p class="text-brand-600 dark:text-brand-400 font-bold uppercase tracking-widest text-xs mb-2">Battle Arena</p>
        <h2 class="text-3xl md:text-5xl font-black text-gray-900 dark:text-white break-words">
            ì–´ëŠ ìª½ì˜ <span
                class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-pink-500 whitespace-nowrap">{{
                category_name }}</span>?
        </h2>
    </div>

    <!-- ëŒ€ê²° ì¹´ë“œ ì˜ì—­ -->
    <div class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6 md:gap-8 items-stretch">

        <!-- Anime 1 -->
        <div id="card-1" onclick="submitVote('1')"
            class="group relative bg-white dark:bg-gray-800 rounded-3xl p-6 md:p-8 shadow-xl hover:shadow-2xl hover:shadow-brand-500/20 border-2 border-transparent hover:border-brand-500 cursor-pointer transition-all duration-300 transform hover:-translate-y-2 flex flex-col justify-center items-center min-h-[280px] md:min-h-[450px]">

            <div
                class="absolute -top-3 -left-3 md:-top-4 md:-left-4 w-10 h-10 md:w-12 md:h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center font-black text-lg md:text-xl text-gray-400 group-hover:bg-brand-500 group-hover:text-white transition-colors z-10 shadow-sm">
                A
            </div>

            <div class="flex-grow flex items-center justify-center w-full my-4">
                <h3
                    class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-black text-center text-gray-800 dark:text-gray-100 group-hover:text-brand-600 dark:group-hover:text-brand-400 break-words leading-tight transition-colors w-full px-2">
                    {{ anime1.name }}
                </h3>
            </div>

            <div class="mt-4 flex justify-center">
                <span
                    class="bg-gray-100 dark:bg-gray-700 px-4 py-1.5 rounded-full text-xs md:text-sm font-mono text-gray-500 dark:text-gray-400 group-hover:text-brand-600 dark:group-hover:text-brand-300 transition-colors">
                    Rating: {{ anime1['rating_' + category_key]|round|int }}
                </span>
            </div>

            <div id="result-overlay-1"
                class="absolute inset-0 bg-brand-600/10 dark:bg-brand-400/10 rounded-3xl border-4 border-brand-500 hidden transition-all z-20">
                <div class="absolute inset-0 flex items-center justify-center">
                    <span
                        class="bg-brand-600 text-white text-xl md:text-2xl font-bold px-6 py-2 rounded-full shadow-lg transform -rotate-12">WINNER</span>
                </div>
            </div>
        </div>

        <!-- VS Section (Center) & Probability Bar -->
        <div class="flex flex-col items-center justify-center gap-4 z-20 py-4 md:py-0 min-w-[120px]">
            <div
                class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center font-black text-lg md:text-xl italic text-gray-500 dark:text-gray-400 shadow-inner ring-4 ring-gray-50 dark:ring-gray-900">
                VS
            </div>

            <!-- í™•ë¥  ê·¸ë˜í”„ -->
            <div class="w-full flex flex-col gap-1 items-center mb-2 px-2">
                <div class="flex justify-between w-full text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">
                    <span class="text-brand-500">{{ probs.win_a }}%</span>
                    <span>Draw</span>
                    <span class="text-pink-500">{{ probs.win_b }}%</span>
                </div>
                <div class="flex w-full h-1.5 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800">
                    <div style="width: {{ probs.win_a }}%" class="bg-brand-500 h-full"></div>
                    <div style="width: {{ probs.draw }}%" class="bg-gray-300 dark:bg-gray-600 h-full"></div>
                    <div style="width: {{ probs.win_b }}%" class="bg-pink-500 h-full"></div>
                </div>
            </div>

            <button onclick="submitVote('draw')"
                class="px-6 py-2 rounded-full border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 font-bold text-xs md:text-sm transition-colors whitespace-nowrap shadow-sm bg-white dark:bg-gray-800">
                ë¬´ìŠ¹ë¶€
            </button>
        </div>

        <!-- Anime 2 -->
        <div id="card-2" onclick="submitVote('2')"
            class="group relative bg-white dark:bg-gray-800 rounded-3xl p-6 md:p-8 shadow-xl hover:shadow-2xl hover:shadow-pink-500/20 border-2 border-transparent hover:border-pink-500 cursor-pointer transition-all duration-300 transform hover:-translate-y-2 flex flex-col justify-center items-center min-h-[280px] md:min-h-[450px]">

            <div
                class="absolute -top-3 -right-3 md:-top-4 md:-right-4 w-10 h-10 md:w-12 md:h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center font-black text-lg md:text-xl text-gray-400 group-hover:bg-pink-500 group-hover:text-white transition-colors z-10 shadow-sm">
                B
            </div>

            <div class="flex-grow flex items-center justify-center w-full my-4">
                <h3
                    class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-black text-center text-gray-800 dark:text-gray-100 group-hover:text-pink-600 dark:group-hover:text-pink-400 break-words leading-tight transition-colors w-full px-2">
                    {{ anime2.name }}
                </h3>
            </div>

            <div class="mt-4 flex justify-center">
                <span
                    class="bg-gray-100 dark:bg-gray-700 px-4 py-1.5 rounded-full text-xs md:text-sm font-mono text-gray-500 dark:text-gray-400 group-hover:text-pink-600 dark:group-hover:text-pink-300 transition-colors">
                    Rating: {{ anime2['rating_' + category_key]|round|int }}
                </span>
            </div>

            <div id="result-overlay-2"
                class="absolute inset-0 bg-pink-600/10 dark:bg-pink-400/10 rounded-3xl border-4 border-pink-500 hidden transition-all z-20">
                <div class="absolute inset-0 flex items-center justify-center">
                    <span
                        class="bg-pink-600 text-white text-xl md:text-2xl font-bold px-6 py-2 rounded-full shadow-lg transform rotate-12">WINNER</span>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="result-modal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
    <div
        class="bg-white dark:bg-gray-900 p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700 transform scale-95 transition-transform duration-300">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 text-center">Rating Update</h3>

        <div class="flex justify-between items-center mb-8 px-2">
            <!-- P1 -->
            <div class="text-center w-1/3">
                <div class="text-xs text-gray-500 mb-2 truncate px-1">{{ anime1.name }}</div>
                <div id="score-1" class="text-3xl font-mono font-bold text-gray-800 dark:text-gray-100">1200</div>
                <div id="diff-1" class="text-sm font-bold mt-1 opacity-0 transform translate-y-2 transition-all"></div>
            </div>

            <div class="text-gray-300 dark:text-gray-600 text-xl">âœ</div>

            <!-- P2 -->
            <div class="text-center w-1/3">
                <div class="text-xs text-gray-500 mb-2 truncate px-1">{{ anime2.name }}</div>
                <div id="score-2" class="text-3xl font-mono font-bold text-gray-800 dark:text-gray-100">1200</div>
                <div id="diff-2" class="text-sm font-bold mt-1 opacity-0 transform translate-y-2 transition-all"></div>
            </div>
        </div>

        <div class="w-full h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-brand-500 w-0 transition-all duration-[800ms] ease-out"></div>
        </div>
        <p class="text-center text-xs text-gray-400 mt-4">ì ì‹œ í›„ ë‹¤ìŒ ëŒ€ê²°ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const anime1Id = "{{ anime1.id }}";
    const anime2Id = "{{ anime2.id }}";
    const categoryKey = "{{ category_key }}";
    const redirectTo = "{% if focus_mode %}/battle/focus/{{ focus_id }}{% endif %}";

    async function submitVote(winner) {
        if (winner === '1') document.getElementById('result-overlay-1').classList.remove('hidden');
        if (winner === '2') document.getElementById('result-overlay-2').classList.remove('hidden');

        const formData = new FormData();
        formData.append('anime1_id', anime1Id);
        formData.append('anime2_id', anime2Id);
        formData.append('category', categoryKey);
        formData.append('winner', winner);
        if (redirectTo) formData.append('redirect_to', redirectTo);

        try {
            const response = await fetch('/battle/vote', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            showResultAnimation(data);
        } catch (error) {
            console.error('Error:', error);
            location.reload();
        }
    }

    function showResultAnimation(data) {
        const modal = document.getElementById('result-modal');
        const score1El = document.getElementById('score-1');
        const diff1El = document.getElementById('diff-1');
        const score2El = document.getElementById('score-2');
        const diff2El = document.getElementById('diff-2');
        const progressBar = document.getElementById('progress-bar');
        const modalContent = modal.querySelector('div');

        modal.classList.remove('hidden');
        void modal.offsetWidth; // Force Reflow
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');

        score1El.innerText = data.old_r1;
        score2El.innerText = data.old_r2;

        setDiffStyle(diff1El, data.diff_r1);
        setDiffStyle(diff2El, data.diff_r2);

        setTimeout(() => {
            animateValue(score1El, data.old_r1, data.new_r1, 500);
            animateValue(score2El, data.old_r2, data.new_r2, 500);

            diff1El.classList.remove('opacity-0', 'translate-y-2');
            diff2El.classList.remove('opacity-0', 'translate-y-2');

            progressBar.style.width = "100%";
        }, 100);

        setTimeout(() => {
            window.location.href = data.next_url;
        }, 1200);
    }

    function setDiffStyle(element, diff) {
        if (diff > 0) {
            element.innerText = "+" + diff;
            element.className = "text-sm font-bold mt-1 text-green-500 dark:text-green-400 transition-all duration-500 transform";
        } else if (diff < 0) {
            element.innerText = diff;
            element.className = "text-sm font-bold mt-1 text-red-500 dark:text-red-400 transition-all duration-500 transform";
        } else {
            element.innerText = "-";
            element.className = "text-sm font-bold mt-1 text-gray-400 transition-all duration-500 transform";
        }
    }

    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end;
            }
        };
        window.requestAnimationFrame(step);
    }
</script>
{% endblock %}